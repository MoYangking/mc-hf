# 在本项目中添加一个新进程（Supervisor 管理）

本文说明如何向本项目添加一个长期运行的进程（service），并正确配置权限与工作目录。内容参考了 参考文件/spaces-sdks-docker-first-demo.md 中关于 Docker 用户与权限的建议。

## 标准约定（必须遵守）

- 运行用户与权限
  - 容器以非 root 用户运行：UID/GID 均为 1000（见 Dockerfile 的 `USER 1000`）。
  - 复制代码或创建数据目录时，必须设置属主为 1000：
    - 在 Dockerfile 中使用 `COPY --chown=1000:1000 …`，以及必要的 `chown -R 1000:1000`。
  - 任何需要写入的目录（日志、缓存、模型、数据等）都应位于 `/home/user` 或 `/app` 下，并确保对 1000 用户可写。

- 运行环境与工作目录
  - Python 虚拟环境：`/home/user/.venv`，通过 `uv pip`/`pip` 安装依赖；运行命令使用 `/home/user/.venv/bin/python`。
  - 默认环境变量（Dockerfile 中已设置）：
    - `HOME=/home/user`
    - `VIRTUAL_ENV=/home/user/.venv`
    - `PATH=/home/user/.venv/bin:/home/user/.local/bin:$PATH`
  - Supervisor 配置中务必设置 `directory=/home/user/<你的服务目录>`，避免因相对路径或导入路径导致的问题。
  - 建议使用 `command=/bin/bash -lc '…'`，以复用 PATH/HOME 并执行复合命令。

- 端口与路由
  - 网关（OpenResty）对外暴露 7860。如你的服务提供 HTTP，可在运行后通过 `/admin/ui/` 添加一条路由，将某个前缀（如 `/myapi/`）代理到你在容器内监听的端口（例如 `http://127.0.0.1:9000`）。

- 持久化（可选）
  - 若你的服务有需要持久化的数据目录，推荐把该目录纳入同步（Sync）目标以自动推送到远端 Git 仓库：
    - 方式一：设置环境变量 `SYNC_TARGETS`（空格分隔，路径相对 `/`；目录以 `/` 结尾），例如：`home/user/myapi/data/`。
    - 方式二：运行时调用 `/sync/api/targets` 覆盖保存目标列表。

---

## 步骤一：在 Dockerfile 复制代码并安装依赖

以一个 Python FastAPI 服务 `services/myapi` 为例：

```
# 复制服务代码（注意权限）
COPY --chown=1000:1000 services/myapi /home/user/myapi

# 安装依赖（如有）
RUN uv pip install -r /home/user/myapi/requirements.txt --no-cache-dir && \
    chown -R 1000:1000 /home/user/myapi
```

Node 服务类似：

```
COPY --chown=1000:1000 services/webhook /home/user/webhook
RUN cd /home/user/webhook && npm ci && chown -R 1000:1000 /home/user/webhook
```

确保任何需要写入的目录（例如 `/home/user/myapi/data`）在构建时创建并 `chown` 给 1000 用户。

---

## 步骤二（可选）：把数据目录加入同步（Sync）

如果要把你的服务数据纳入自动备份/同步（到远端 Git 仓库），可以：

- 通过环境变量添加：
  - `SYNC_TARGETS="home/user/myapi/data/ home/user/myapi/.env"`
- 或在容器运行后，调用 API：
  - `POST /sync/api/targets`，Body 形如 `{ "targets": ["home/user/myapi/data/"] }`

目录以 `/` 结尾；文件则不以 `/` 结尾。可以使用黑名单（`/sync/api/excludes`）排除某些子路径。

---

## 步骤三：在 Supervisor 中注册你的进程

编辑 `supervisor/supervisord.conf`，新增一个 program 段，例如：

```
[program:myapi]
command=/bin/bash -lc '/home/user/.venv/bin/python -m myapi.app'
directory=/home/user/myapi
autostart=true
autorestart=true
priority=25
stopsignal=TERM
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
# 如需环境变量：
# environment=PORT="9000",SOME_TOKEN="..."
```

对于 Node 服务：

```
[program:webhook]
command=/bin/bash -lc 'node server.js'
directory=/home/user/webhook
autostart=true
autorestart=true
priority=26
stopsignal=TERM
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
stdout_logfile_maxbytes=0
stderr_logfile_maxbytes=0
```

优先级（`priority`）决定启动顺序；现有进程的顺序为：`xvfb(10) → syncd(15) → napcat(20) → astrbot(30) → gemini(35) → nginx(40)`。请为你的服务选择合理的优先级。

---

## 步骤四：可选的路由暴露

你的服务若需要通过统一入口（7860 端口）暴露：

1. 容器启动后访问 `/admin/ui/`；
2. 在“路由规则”中新增一条：`path_prefix=/myapi/`，`backend=http://127.0.0.1:9000`；
3. 保存后即可通过 `https://<host>/myapi/` 访问。

也可直接调用 API `POST /admin/routes.json` 修改路由（见项目 README 中“路由管理 API 速查”）。

---

## 常见问题排查

- 权限错误（EACCES/Permission denied）
  - 目录未 `chown` 给 1000；或写入路径不在 `/home/user`/`/app` 下。
- 导入/相对路径异常
  - `directory` 未正确设置；或未使用虚拟环境的 Python 解释器。
- 依赖不可用
  - 未在 Dockerfile 中安装依赖到 `/home/user/.venv`；或未把执行命令指向该解释器。
- 端口冲突
  - 修改服务监听端口或路由前缀，确保与现有端口不冲突。

---

## 参考资料

- 参考文件/spaces-sdks-docker-first-demo.md（Hugging Face Docker Spaces：用户、权限与 WORKDIR 的最佳实践）
- 项目 README（端口、网关、路由管理 API）

